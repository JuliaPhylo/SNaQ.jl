<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Candidate networks · SNaQ.jl</title><meta name="title" content="Candidate networks · SNaQ.jl"/><meta property="og:title" content="Candidate networks · SNaQ.jl"/><meta property="twitter:title" content="Candidate networks · SNaQ.jl"/><meta name="description" content="Documentation for SNaQ.jl."/><meta property="og:description" content="Documentation for SNaQ.jl."/><meta property="twitter:description" content="Documentation for SNaQ.jl."/><meta property="og:url" content="https://JuliaPhylo.github.io/SNaQ.jl/man/fixednetworkoptim/"/><meta property="twitter:url" content="https://JuliaPhylo.github.io/SNaQ.jl/man/fixednetworkoptim/"/><link rel="canonical" href="https://JuliaPhylo.github.io/SNaQ.jl/man/fixednetworkoptim/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="SNaQ.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">SNaQ.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Manual</span><ul><li><a class="tocitem" href="../installation/">Installation</a></li><li><a class="tocitem" href="../snaq_est/">Network estimation</a></li><li class="is-active"><a class="tocitem" href>Candidate networks</a><ul class="internal"><li><a class="tocitem" href="#Optimizing-parameters-for-a-given-network"><span>Optimizing parameters for a given network</span></a></li><li><a class="tocitem" href="#Network-Score-with-no-optimization"><span>Network Score with no optimization</span></a></li><li><a class="tocitem" href="#Candidate-networks-compatible-with-a-known-outgroup"><span>Candidate networks compatible with a known outgroup</span></a></li></ul></li><li><a class="tocitem" href="../expectedCFs/">Extract expected CFs</a></li><li><a class="tocitem" href="../bootstrap/">Bootstrap</a></li><li><a class="tocitem" href="../parallelcomputation/">Parallel computation</a></li><li><a class="tocitem" href="../multiplealleles/">Multiple alleles</a></li><li><a class="tocitem" href="../error_reporting/">Error reporting</a></li></ul></li><li><span class="tocitem">Library</span><ul><li><a class="tocitem" href="../../lib/public/">Public</a></li><li><a class="tocitem" href="../../lib/internals/">Internals</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Manual</a></li><li class="is-active"><a href>Candidate networks</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Candidate networks</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaPhylo/SNaQ.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JuliaPhylo/SNaQ.jl/blob/dev/docs/src/man/fixednetworkoptim.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Candidate-networks"><a class="docs-heading-anchor" href="#Candidate-networks">Candidate networks</a><a id="Candidate-networks-1"></a><a class="docs-heading-anchor-permalink" href="#Candidate-networks" title="Permalink"></a></h1><h2 id="Optimizing-parameters-for-a-given-network"><a class="docs-heading-anchor" href="#Optimizing-parameters-for-a-given-network">Optimizing parameters for a given network</a><a id="Optimizing-parameters-for-a-given-network-1"></a><a class="docs-heading-anchor-permalink" href="#Optimizing-parameters-for-a-given-network" title="Permalink"></a></h2><p>For a given network topology, we can optimize the branch lengths and inheritance probabilities (γ) with the pseudolikelihood. This is useful if we have a few candidate networks to compare. Each network can be optimized individually, and the network with the best pseudolikelihood can be chosen.</p><p>The score being optimized is a pseudo-deviance, i.e. a multiple of the negative log pseudo-likelihood up to an additive constant (the lower the better; a pseudo-deviance of 0 corresponds to a perfect fit).</p><p>Following our example in <a href="../snaq_est/#Estimating-a-network">Estimating a network</a>, we can optimize parameters on the true network (the one originally used to simulate the data).  Given a table of CFs and a network, the function <a href="../../lib/public/#SNaQ.topologymaxQpseudolik!-Tuple{HybridNetwork, DataCF}"><code>topologymaxQpseudolik!</code></a> returns the same network topology but with optimized branch lengths and inheritance values:</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; truenet = readnewick(&quot;((((D:0.4,C:0.4):4.8,((A:0.8,B:0.8):2.2)#H1:2.2::0.7):4.0,(#H1:0::0.3,E:3.0):6.2):2.0,O:11.2);&quot;);</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; net1alt = topologymaxQpseudolik!(truenet, raxmlCF);</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; writenewick(net1alt, round=true)</code><code class="nohighlight hljs ansi" style="display:block;">&quot;(D,C,(((A,B):0.843)#H1:6.976::0.769,((#H1:0.005::0.231,E):1.999,O):1.051):9.37);&quot;</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; loglik(net1alt) # pseudo deviance actually: the lower the better</code><code class="nohighlight hljs ansi" style="display:block;">29.785803396816462</code></pre><pre><code class="language-julia hljs">using PhyloPlots, RCall
R&quot;par&quot;(mar=[0,0,0,0])
plot(net1alt, showgamma=true);</code></pre><p><img src="../../assets/figures/truenet_opt.svg" alt="truenet_opt"/></p><p>We get a score of 29.786, which is comparable to the score of the SNaQ network (net1: 28.315), especially compared to the score of the best tree (net0: 53.532). This begs the question: is the true network within the &quot;range&quot; of uncertainty? We can run a <a href="../bootstrap/#Bootstrap">Bootstrap</a> analysis to measure uncertainty in our network inference.</p><p>For a more thorough optimization, we could change the arguments for the tolerances (<code>ftolRel</code> and <code>xtolAbs</code>) used to determine when the parameters are optimized and the search stops (but the optimization will take longer). It makes no difference on this small data set.</p><pre><code class="language-julia hljs">net1par = topologymaxQpseudolik!(truenet, raxmlCF, ftolRel=1e-10, xtolAbs=1e-10)
loglik(net1par) # pseudo deviance, actually: the lower the better</code></pre><h2 id="Network-Score-with-no-optimization"><a class="docs-heading-anchor" href="#Network-Score-with-no-optimization">Network Score with no optimization</a><a id="Network-Score-with-no-optimization-1"></a><a class="docs-heading-anchor-permalink" href="#Network-Score-with-no-optimization" title="Permalink"></a></h2><p>For a network with given branch lengths and γ heritabilies, we can compute the pseudolikelihood (well, a pseudo-deviance) with:</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; topologyQpseudolik!(truenet,raxmlCF);</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; loglik(truenet) # again, pseudo deviance</code><code class="nohighlight hljs ansi" style="display:block;">153.53102953930053</code></pre><p>This function is not maximizing the pseudolikelihood, it is simply computing the pseudolikelihood (or deviance) for the given branch lengths and probabilities of inheritance. At the moment, both of these functions require that the given network is of level 1 (cycles don&#39;t overlap).</p><h2 id="Candidate-networks-compatible-with-a-known-outgroup"><a class="docs-heading-anchor" href="#Candidate-networks-compatible-with-a-known-outgroup">Candidate networks compatible with a known outgroup</a><a id="Candidate-networks-compatible-with-a-known-outgroup-1"></a><a class="docs-heading-anchor-permalink" href="#Candidate-networks-compatible-with-a-known-outgroup" title="Permalink"></a></h2><p>If the network was estimated via <a href="../../lib/public/#SNaQ.snaq!-Tuple{HybridNetwork, DataCF}"><code>snaq!</code></a>, it might turn out to be impossible to root our estimated network with a known outgroup. At this time, <code>snaq!</code> does not impose any rooting constraint on the network: the search for the lowest score considers all level-1 networks, including those that are incompatible with a known outgroup. (The monophyly of outgroups is not imposed either, like in many other methods.)</p><p>If the estimated network cannot be rooted with the known outgroup, we can check the <code>.networks</code> output file for a possible alternative network. It has a list of networks that are slight modifications of the best network, where the modifications changed the direction of one reticulation at a time. For each modified network, the score was calculated. So if we find in this list a modified network that has a score close to that of the best network, and that can be re-rooted with our known root position, then this modified network is a better candidate than the network with the best score.</p><p>Below is what the <code>net1.networks</code> file looks like, after performing the analysis in the section <a href="../snaq_est/#Network-estimation">Network estimation</a>. Scroll to the right to see the scores.</p><pre><code class="nohighlight hljs">(C,D,((O,(E,#H7:::0.19558838614943078):0.31352437658618976):0.6640664399202987,(B,(A)#H7:::0.8044116138505693):10.0):10.0);, with -loglik 28.31506721890958 (best network found, remaining sorted by log-pseudolik; the smaller, the better)
(C,D,((O,(E)#H7:::0.8150784689693145):0.9336405757682176,(B,(A,#H7:::0.18492153103068557):0.25386142779877724):1.8758156446611114):10.0);, with -loglik 31.535560380783814
(B,#H7:9.90999345612101::0.2555404440833535,(A,(E,(O,((C,D):10.0)#H7:0.3419231810962026::0.7444595559166465):0.19994859441332047):2.5014911511063644):0.7957621793330066);, with -loglik 56.64548310161462
(C,D,((O,(E,((B)#H7:::0.7957543284159452,A):4.786202415937916):0.004527712280136759):1.7952610454570868,#H7:::0.20424567158405482):10.0);, with -loglik 67.17775727492258
(C,D,(#H7:::0.32947301811471164,(B,(A,(E,(O)#H7:::0.6705269818852884):1.371799259141243):0.0):6.397073999864152):7.677245926003807);, with -loglik 199.11401961057143</code></pre><p>We can read this file and look at its list of networks like this:</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; file = &quot;net1.networks&quot;;
       # or use the example file available with the package:</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; file = joinpath(dirname(pathof(SNaQ)), &quot;..&quot;,&quot;examples&quot;,&quot;net1.networks&quot;);</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; netlist = readmultinewick(file) # read the full list of networks in that file</code><code class="nohighlight hljs ansi" style="display:block;">5-element Vector{HybridNetwork}:
 HybridNetwork, Rooted Network
12 edges
12 nodes: 6 tips, 1 hybrid nodes, 5 internal tree nodes.
tip labels: C, D, O, E, ...
(C,D,((O,(E,#H7:::0.196):0.314):0.664,(B,(A)#H7:::0.804):10.0):10.0);

 HybridNetwork, Rooted Network
12 edges
12 nodes: 6 tips, 1 hybrid nodes, 5 internal tree nodes.
tip labels: C, D, O, E, ...
(C,D,((O,(E)#H7:::0.815):0.934,(B,(A,#H7:::0.185):0.254):1.876):10.0);

 HybridNetwork, Rooted Network
12 edges
12 nodes: 6 tips, 1 hybrid nodes, 5 internal tree nodes.
tip labels: B, A, E, O, ...
(B,#H7:9.91::0.256,(A,(E,(O,((C,D):10.0)#H7:0.342::0.744):0.2):2.501):0.796);

 HybridNetwork, Rooted Network
12 edges
12 nodes: 6 tips, 1 hybrid nodes, 5 internal tree nodes.
tip labels: C, D, O, E, ...
(C,D,((O,(E,((B)#H7:::0.796,A):4.786):0.005):1.795,#H7:::0.204):10.0);

 HybridNetwork, Rooted Network
12 edges
12 nodes: 6 tips, 1 hybrid nodes, 5 internal tree nodes.
tip labels: C, D, B, A, ...
(C,D,(#H7:::0.329,(B,(A,(E,(O)#H7:::0.671):1.372):0.0):6.397):7.677);</code></pre><p>Next, we would like to extract the network scores from the file. Below is some code for doing this in julia</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; score_in_string = read(file, String); # read the file as a single string</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; score_in_string = (x-&gt; x[1]).(collect(eachmatch(r&quot;with -loglik ([0-9]+.[0-9]+)&quot;,score_in_string))); # find all occurences of the loglik scores</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; scores = parse.(Float64, score_in_string); # parse those matches into numbers
       
       # next: update the &quot;loglik&quot; of each network with the score read from the file</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; for i in eachindex(netlist)
          netlist[i].fscore = scores[i]
          println(&quot;net $i in the list: score = &quot;,scores[i])
       end</code><code class="nohighlight hljs ansi" style="display:block;">net 1 in the list: score = 28.31506721890958
net 2 in the list: score = 31.535560380783814
net 3 in the list: score = 56.64548310161462
net 4 in the list: score = 67.17775727492258
net 5 in the list: score = 199.11401961057143</code></pre><p>The first network in the list is the best network returned by <a href="../../lib/public/#SNaQ.snaq!-Tuple{HybridNetwork, DataCF}"><code>snaq!</code></a>. We see that the second network has a score that&#39;s not too far, but the other networks have worse scores. The best network and its best modification (second network in the list) are shown below. We chose to show edge numbers, to use them later to re-root the networks.</p><pre><code class="language-julia hljs">plot(netlist[1], showgamma=true, showedgenumber=true, tipoffset=0.1);
R&quot;mtext&quot;(&quot;best net, score=28.3&quot;, line=-1);
plot(netlist[2], showgamma=true, showedgenumber=true, tipoffset=0.1);
R&quot;mtext&quot;(&quot;direction modified, score=31.5&quot;, line=-1);</code></pre><p><img src="../../assets/figures/fixednetworkoptim_othernets1.svg" alt="othernets before reroot"/></p><p>Now imagine that our outgroup is taxon A.</p><p>Best network: we would get a <code>RootMismatch</code> error if we tried to set the root on the external edge 9 to A, with <code>rootatnode!(netlist[1], &quot;A&quot;)</code> (see the PhyloNetworks guide <a href="https://juliaphylo.github.io/PhyloNetworks.jl/stable/man/dist_reroot/#Does-the-root-conflict-with-the-direction-of-a-reticulation%3F">Does the root conflict with the direction of a reticulation?</a>). But we could root the best network on the major parent edge to A, edge 10 (rooted network on the left below).</p><pre><code class="language-julia hljs">rootonedge!(netlist[1], 10); # root best net to make A outgroup
rotate!(netlist[1], -4); # to &#39;un-cross&#39; edges
rotate!(netlist[1], -6);
rotate!(netlist[1], -5);
plot(netlist[1], showgamma=true, tipoffset=0.1);
R&quot;mtext&quot;(&quot;best net, score=28.3&quot;, line=-1);
rootatnode!(netlist[2], &quot;A&quot;); # net with modified direction: first way to make A outgroup
rotate!(netlist[2], -4) # to &#39;un-cross&#39; edges
rotate!(netlist[2], -6)
plot(netlist[2], showgamma=true, tipoffset=0.1);
R&quot;mtext&quot;(&quot;second best in list, score=31.5\nrequires unsampled population&quot;, line=-2);
rootonedge!(netlist[2], 10) # net with modified direction: second way to make A outgroup
for i in [9,-7] rotate!(netlist[2], i); end; # to &#39;un-cross&#39; edges
plot(netlist[2], showgamma=true, tipoffset=0.1);
R&quot;mtext&quot;(&quot;second best in list, score=31.5\ndifferent root position&quot;, line=-2);</code></pre><p><img src="../../assets/figures/fixednetworkoptim_othernets2.svg" alt="othernets after reroot"/></p><p>For the second best network in our list, there are 2 ways to root it with A. These 2 options give quite different rooted versions of the network:</p><ol><li>On the external edge 8 to A (top right). This requires the existence of an unsampled taxon, sister to BDCOE, that would have contributed to introgression into an ancestor of E.</li><li>On its parent edge 10 (bottom right).</li></ol><p>A is an outgroup in both rootings, but the second option is more parsimonious, in the sense that it does not outright require the existence of a &quot;ghost&quot; taxon: a taxon that went extinct after the introgression, or that is unsampled.</p><p>This second rooted version is consistent with 2 possibilities. It could arise either from   (a) an unsampled taxon sister to A that contributed to introgression, or   (b) a direct ancestor of A could have contributed to the introgression into the ancestor of E.   Case (a) stipulates the existence of an unsampled (&quot;ghost&quot;) taxon, but case (b) does not require any unsampled taxon.</p><p>These two possibilities differ in the length of their gene flow edge (light blue, here with γ=0.185). If gene flow came from an unsampled taxon under case (a), this edge would have positive length, in calendar time. If gene flow came from a direct ancestor of A under case (b), the gene flow edge would have length 0.</p><p>Edge lengths from SNaQ should be interpreted with caution to distinguish between the two possibilities because:</p><ul><li>edge lengths estimated with SNaQ are in coalescent units instead of calendar time, and necessarily include estimation error;</li><li>an edge with a true length of 0 may be estimated to have a non-zero length in coalescent units due to errors in estimated gene trees, to help explain gene tree discordance;</li><li>an incorrect topology may result in edges of estimated length 0;</li><li>and some edge lengths are not identifiable from quartet concordance factors anyway.</li></ul><p>To distinguish between these possibilities, models that separate calendar time, substitution rate, and population size can be useful. Using stronger assumptions than SNaQ (e.g. a molecular clock), the rooted network and branch lengths may be identifiable, so networks with / without unsampled taxa may be distinguished. See for example <a href="https://doi.org/10.1111/tpj.16859">Zhang et al. 2024</a>, who used BPP. Note that the model named &quot;<a href="https://bpp.github.io/bpp-manual/bpp-4-manual/#the-msc-i-model">MSci</a>&quot; in BPP is exactly the same as the network multispecies coalescent, and is typically named NMSC in most papers.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../snaq_est/">« Network estimation</a><a class="docs-footer-nextpage" href="../expectedCFs/">Extract expected CFs »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.10.2 on <span class="colophon-date" title="Tuesday 6 May 2025 17:41">Tuesday 6 May 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
