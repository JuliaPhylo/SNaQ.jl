<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Improving runtimes · SNaQ.jl</title><meta name="title" content="Improving runtimes · SNaQ.jl"/><meta property="og:title" content="Improving runtimes · SNaQ.jl"/><meta property="twitter:title" content="Improving runtimes · SNaQ.jl"/><meta name="description" content="Documentation for SNaQ.jl."/><meta property="og:description" content="Documentation for SNaQ.jl."/><meta property="twitter:description" content="Documentation for SNaQ.jl."/><meta property="og:url" content="https://JuliaPhylo.github.io/SNaQ.jl/man/parallelcomputation/"/><meta property="twitter:url" content="https://JuliaPhylo.github.io/SNaQ.jl/man/parallelcomputation/"/><link rel="canonical" href="https://JuliaPhylo.github.io/SNaQ.jl/man/parallelcomputation/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="SNaQ.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">SNaQ.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Manual</span><ul><li><a class="tocitem" href="../installation/">Installation</a></li><li><a class="tocitem" href="../snaq_est/">Network estimation</a></li><li><a class="tocitem" href="../fixednetworkoptim/">Candidate networks</a></li><li><a class="tocitem" href="../expectedCFs/">Extract expected CFs</a></li><li><a class="tocitem" href="../bootstrap/">Bootstrap</a></li><li class="is-active"><a class="tocitem" href>Improving runtimes</a><ul class="internal"><li><a class="tocitem" href="#Parallel-runs"><span>Parallel runs</span></a></li><li><a class="tocitem" href="#Parallel-quartet-likelihood"><span>Parallel quartet likelihood</span></a></li><li><a class="tocitem" href="#Quartet-subsampling"><span>Quartet subsampling</span></a></li></ul></li><li><a class="tocitem" href="../multiplealleles/">Multiple alleles</a></li><li><a class="tocitem" href="../error_reporting/">Error reporting</a></li></ul></li><li><span class="tocitem">Library</span><ul><li><a class="tocitem" href="../../lib/public/">Public</a></li><li><a class="tocitem" href="../../lib/internals/">Internals</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Manual</a></li><li class="is-active"><a href>Improving runtimes</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Improving runtimes</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaPhylo/SNaQ.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JuliaPhylo/SNaQ.jl/blob/dev/docs/temp_src_for_build/man/parallelcomputation.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><div class="admonition is-info" id="Important-Note:-6fd744e54e9b023e"><header class="admonition-header">Important Note:<a class="admonition-anchor" href="#Important-Note:-6fd744e54e9b023e" title="Permalink"></a></header><div class="admonition-body"><p>This documentation pertains to SNaQ v1.1 and may differ from the specific implementation originally described in <a href="https://doi.org/10.1371/journal.pgen.1005896">Solís-Lemus &amp; Ané (2016)</a>. See documentation SNaQ v1.0  for the original implementation.</p></div></div><h1 id="Improving-runtimes"><a class="docs-heading-anchor" href="#Improving-runtimes">Improving runtimes</a><a id="Improving-runtimes-1"></a><a class="docs-heading-anchor-permalink" href="#Improving-runtimes" title="Permalink"></a></h1><h2 id="Parallel-runs"><a class="docs-heading-anchor" href="#Parallel-runs">Parallel runs</a><a id="Parallel-runs-1"></a><a class="docs-heading-anchor-permalink" href="#Parallel-runs" title="Permalink"></a></h2><p>For network estimation, multiple runs can done in parallel. For example, if your machine has 4 or more processors (or cores), you can tell julia to use 4 processors by starting julia with <code>julia -p3</code>, or by starting julia the usual way (<code>julia</code>) and then adding processors with:</p><pre><code class="language-julia hljs">using Distributed
addprocs(3)</code></pre><div class="admonition is-info" id="Note-4fada1f72bc7c9e9"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-4fada1f72bc7c9e9" title="Permalink"></a></header><div class="admonition-body"><p>The <code>-p</code> argument for <code>julia</code> denotes <em>additional</em> processors. So, <code>julia -p3</code> will start Julia with <em>4</em> processors.</p></div></div><p>If we load a package (<code>using SNaQ</code>) before adding processors, then we need to re-load it again so that all processors have access to it:</p><pre><code class="language-julia hljs">@everywhere using PhyloNetworks, SNaQ</code></pre><p>After that, running the <code>snaq!(...)</code> command will use different cores for the different independent runs specified by  optional <code>runs</code> argument, as processors become available.</p><p>When running <a href="../../lib/public/#SNaQ.bootsnaq-Tuple{HybridNetwork, Union{DataFrames.DataFrame, Vector{Vector{HybridNetwork}}}}"><code>bootsnaq</code></a>, the analysis of each bootstrap replicate will use multiple cores to parallelize separate runs of that particular bootstrap replicate. You may parallelize things further by running <code>bootsnaq</code> multiple times (on separate machines for instance), each time for a small subset of bootstrap replicates, and with a different seed each time.</p><p>We may tell julia to add more processors than our machine has, but we will not receive any performance benefits. At any time during the julia session, <code>nworkers()</code> tells us how many worker processors julia has access to.</p><p>Below is an example of how to use a cluster, to run many independent <a href="../../lib/public/#SNaQ.snaq!-Tuple{HybridNetwork, DataCF}"><code>snaq!</code></a> searches in parallel on a cluster running the <a href="https://slurm.schedmd.com">slurm</a> job manager (other managers would require a different, but similar submit file). This example uses 2 files:</p><ol><li>a julia script file, to do many runs of <code>snaq!</code> in parallel, asking for many cores (default: 10 runs, asking for 10 cores). This julia script can take arguments: the maximum allowed number of hybridizations <code>hmax</code>, and the number of runs (to run 50 runs instead of 10, say).</li><li>a submit file, to launch the julia script.</li></ol><p><strong>First</strong>: the example julia script, below or <a href="https://github.com/juliaphylo/SNaQ/blob/main/examples/runSNaQ.jl">here</a>, is assumed (by the submit file) to be called <code>runSNaQ.jl</code>. It uses a starting tree that is assumed to be available in a file named <code>astraltree.tre</code>, but that could be modified (to use a network with h=1 to start the search with hmax=2 for instance). It also assumes that the quartet concordance factor data are in file <code>tableCF_speciesNames.csv</code>. Again, this file name should be adjusted. To run this julia script for 50 runs and hmax=3, do <code>julia runSNaQ.jl 3 50</code>.</p><pre><code class="language-julia hljs">#!/usr/bin/env julia

# file &quot;runSNaQ.jl&quot;. run in the shell like this in general:
# julia runSNaQ.jl hvalue nruns
# example for h=2 and default 10 runs:
# julia runSNaQ.jl 2
# or example for h=3 and 50 runs:
# julia runSNaQ.jl 3 50

length(ARGS) &gt; 0 ||
    error(&quot;need 1 or 2 arguments: # reticulations (h) and # runs (optional, 10 by default)&quot;)
h = parse(Int, ARGS[1])
nruns = 10
if length(ARGS) &gt; 1
    nruns = parse(Int, ARGS[2])
end
outputfile = string(&quot;net&quot;, h, &quot;_&quot;, nruns, &quot;runs&quot;) # example: &quot;net2_10runs&quot;
seed = 1234 + h # change as desired! Best to have it different for different h
@info &quot;will run SNaQ with h=$h, # of runs=$nruns, seed=$seed, output will go to: $outputfile&quot;

using Distributed
addprocs(nruns)
@everywhere using SNaQ
net0 = readnewick(&quot;astraltree.tre&quot;);
using DataFrames, CSV
df_sp = CSV.read(&quot;tableCF_speciesNames.csv&quot;, DataFrame; pool=false);
d_sp = readtableCF!(df_sp);
net = snaq!(net0, d_sp, hmax=2, filename=outputfile, seed=seed, runs=nruns)</code></pre><p>When julia is called on a script, whatever comes after &quot;julia scriptname&quot; is given to julia in an array of values. This array is called <code>ARGS</code>. So if we call a script like this: <code>julia runSNaQ.jl 2</code> then the script will know the arguments through <code>ARGS</code>, which would contain a single element, <code>&quot;2&quot;</code>. This first element is just a string, at this stage. We want to use it as a number, so we need to ask julia to parse the string into an integer.</p><p><strong>Second</strong>: we need a &quot;submit&quot; file to ask a job scheduler like <a href="https://slurm.schedmd.com">slurm</a> to submit our julia script to a cluster. In the submit file below, the first 5 lines set things up for slurm. They are most likely to be specific to your cluster. The main idea here is to use a slurm &quot;array&quot; from 0 to 3, to run our julia script multiple times, 4 times actually: from hmax=0 to hmax=3. Each would do 30 runs (and each would be allocated 30 cores in the submit script below). Then log out of the cluster and go for coffee.</p><pre><code class="language-bash hljs">#!/bin/bash
#SBATCH -o path/to/slurm/log/file/runsnaq_slurm%a.log
#SBATCH -J runsnaq
#SBATCH --array=0-3
#SBATCH -c 30
## --array: to run multiple instances of this script,
##          one for each value in the array.
##          1 instance = 1 task
## -J job name
## -c number of cores (CPUs) per task

echo &quot;slurm task ID = $SLURM_ARRAY_TASK_ID used as hmax&quot;
echo &quot;start of SNaQ parallel runs on $(hostname)&quot;
# finally: launch the julia script, using Julia executable appropriate for slurm, with full paths:
/workspace/software/bin/julia --history-file=no -- runSNaQ.jl $SLURM_ARRAY_TASK_ID 30 &gt; net${SLURM_ARRAY_TASK_ID}_30runs.screenlog 2&gt;&amp;1
echo &quot;end of SNaQ run ...&quot;</code></pre><h2 id="Parallel-quartet-likelihood"><a class="docs-heading-anchor" href="#Parallel-quartet-likelihood">Parallel quartet likelihood</a><a id="Parallel-quartet-likelihood-1"></a><a class="docs-heading-anchor-permalink" href="#Parallel-quartet-likelihood" title="Permalink"></a></h2><p>This section describes the functionalities for scalability improvements in <a href>Kolbow et al 2025</a> for SNaQ (v1.1).</p><p>Each step of optimization involves computing the likelihood of each quartet. Since SNaQ treats quartet likelihoods as independent, their likelihoods can be computed in parallel with multi-threading.  To enable multi-threading, the user needs to specify how many threads are avaliable when starting a Julia session with the <code>--threads</code> flag:</p><pre><code class="language-bash hljs">julia --threads=8 #use 8 threads</code></pre><p>SNaQ then automatically multi-threads quartet likelihoods, if given the opportunity.  Setting <code>--threads=auto</code> uses all avaliable CPU threads.</p><h2 id="Quartet-subsampling"><a class="docs-heading-anchor" href="#Quartet-subsampling">Quartet subsampling</a><a id="Quartet-subsampling-1"></a><a class="docs-heading-anchor-permalink" href="#Quartet-subsampling" title="Permalink"></a></h2><p>For a network with <span>$N$</span> taxa, there are <span>$\binom{N}{4}$</span> different quartets, meaning that the complexity of likelihood computation balloons quartically with respect to the number of taxa.  In cases where the number of taxa causes network estimation to be prohibitively slow, we implemented a strategy that only uses a fraction of all quartets when computing the likelihood. For a network with <span>$\binom{N}{4}$</span> quartets, the optional <code>propQuartets</code> argument can be used to randomly sample <span>$\lceil \binom{N}{4} \cdot$</span> <code>propQuartets</code> <span>$\rceil$</span> quartets. Although we lose some information when subsampling quartets, using <code>propQuartets</code> as low as <code>0.5</code> has been shown to not signifcantly decrease accuracy.</p><p>We can run the same analysis as the <a href="../snaq_est/#Estimating-a-network">Estimating a network</a> section and comapre the two networks when we use only a fraction of the quartets. </p><pre><code class="language-julia hljs">raxmltrees = joinpath(dirname(pathof(SNaQ)), &quot;..&quot;,&quot;examples&quot;,&quot;raxmltrees.tre&quot;);
raxmlCF = readtrees2CF(raxmltrees)
astralfile = joinpath(dirname(pathof(SNaQ)), &quot;..&quot;,&quot;examples&quot;,&quot;astral.tre&quot;);
astraltree = readmultinewick(astralfile)[102] # 102th tree: last tree here

net0 = snaq!(astraltree,raxmlCF, hmax=0, filename=&quot;net0&quot;, propQuartets=0.75)</code></pre><h3 id="Removing-uninformative-quartets"><a class="docs-heading-anchor" href="#Removing-uninformative-quartets">Removing uninformative quartets</a><a id="Removing-uninformative-quartets-1"></a><a class="docs-heading-anchor-permalink" href="#Removing-uninformative-quartets" title="Permalink"></a></h3><p>We can further reduce computational costs with minimal detriment to accuracy by ignoring uniformative quartets. A star tree would give concordance factors of <span>$\frac{1}{3}$</span> for all quartet topologies, thus, quartets with CFs near <span>$\frac{1}{3}$</span> may not be informative of the overall species topology. We can check for and remove uninformative quartets by setting  the optional keyword argument <code>qinfTest</code> to <code>true</code>. Any quartets with concordance factors sufficiently close to <span>$\frac{1}{3}$</span> will be removed when  computing the composite likelihood.  Further, the optional keyword argument <code>qtolAbs</code> can be used to specify the tolerence for determining what concordance factors are &quot;close enough&quot; to <span>$\frac{1}{3}$</span>.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../bootstrap/">« Bootstrap</a><a class="docs-footer-nextpage" href="../multiplealleles/">Multiple alleles »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.16.1 on <span class="colophon-date" title="Monday 1 December 2025 21:06">Monday 1 December 2025</span>. Using Julia version 1.12.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
